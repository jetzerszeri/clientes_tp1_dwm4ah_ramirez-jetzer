<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear cuenta</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://kit.fontawesome.com/26eb2bb81f.js" crossorigin="anonymous"></script>
</head>
<body>
    <header class="navegacion">
        <nav >
            <div class="navbar">
                <div>
                    <a href="/" class="navbarlogo">GbyG PCS</a>
    
                    <div class="toggle-button">
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </div>
                    
                </div>
    
                <div class="navbar-links">
                    <ul>
                        <li><a href="/">Inicio</a></li>
                        <li><a href="/services.html" >Servicios</a></li>
                        <li><a href="/admin.html">Dashboard</a></li>
                    </ul>
                    <div>
                        <a href="/login.html" class="btn">Iniciar sesión</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="loginmain">
        <nav class="breadcrumb">
            <ol>
                <li><a href="/">Home</a></li>
                <li aria-current="page">Panel de administrador</li>
            </ol>
        </nav>
    
        <h1>Crear cuenta</h1>

        <div class="container">
    
            <form action="">
        
                <div>
                    <label for="name">Nombre</label>
                    <input type="text" name="name">
                </div>
                <div>
                    <label for="lastname">Apellido</label>
                    <input type="text" name="lastname">
                </div>
                <div>
                    <label for="email">E-mail</label>
                    <input type="text" name="email">
                </div>
        
                <div>
                    <label for="password">Contraseña</label>
                    <input type="password" name="password">
                </div>
        
                <div>
                    <button type="submit" class="btn primary-green">Crear cuenta</button>
                </div>
            </form>

            <div class="signupmsg">
                <p>Ya tienes una cuenta?</p>
                <a href="/login.html" class="btn">Inicia sesión aquí</a>
            </div>


        </div>
    
    
    </main>

    <footer>
        <div>
            <ul>
                <li><a href="https://www.facebook.com" target="_blank"><i class="fa-brands fa-facebook"></i></a></li>
                <li><a href="https://twitter.com" target="_blank"><i class="fa-brands fa-x-twitter"></i></i></a></li>
                <li><a href="https://www.instagram.com" target="_blank"><i class="fa-brands fa-instagram"></i></a></li>
            </ul>
            <div>
                <p>gbygpcs.com</p>
                <p>© 2023 Copyright</p>
            </div>
        </div>
    </footer>

<script type="module">
    // import app from './js/config.js';
    // import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";
    // import { getFirestore, collection, addDoc, getDocs, orderBy, query, setDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js';
    // import {getDatabase, ref, set, push} from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js';


    // const auth = getAuth(app);
    // const db = getFirestore(app);
    // const db2 = getDatabase(app);

    import app from './js/app.js';
//     function clearErrorMessages(query) {
//     const errorMessages = document.querySelectorAll(query);
//     errorMessages.forEach((msj) => {
//         msj.remove();
//     });
// }

// function displayErrorMessage(message, targetElement, formTarget) {
//     const p = document.createElement('p');
//     p.classList.add('errorForMmsg');
//     p.innerText = message;

//     if (formTarget){
//         targetElement.prepend(p);
//     } else {
//         targetElement.parentElement.appendChild(p);
//     }
// }


    // function validateEmptyFields(array) {
    //     array.forEach((input) => {
    //         if (!input.value.trim()) {
    //             app.main.displayErrorMessage('Este campo no puede estar vacío', input);
    //         }
    //     });

    //     let errorMessages = document.querySelectorAll('.errorForMmsg');
    //     if (errorMessages.length > 0) {
    //         return false;
    //     } else {
    //         return true;
    //     }
    // }

// function createUserAndSetDocument(email, password, name, lastname) {
//     return createUserWithEmailAndPassword(auth, email, password)
//         .then((credentials) => {
//             const user = credentials.user.uid;

//             return setDoc(doc(db, "roles_by_user", user), {
//                 "nombre": name,
//                 "apellido": lastname,
//                 "role": 'customer',
//                 createdAt: serverTimestamp(),
//                 updatedAt: serverTimestamp()
//             });
//         });
// }

// function createChat(user) {
//     const chatRef = ref(db2, 'chats');
//     const newChatRef = push(chatRef);

//     return set(newChatRef, {
//         lastMessage: 'último mensaje',
//         fecha: Date.now(),
//         participants: { [user]: true, 'LIsaefMu3BYpF2jINUV9RH78EZs2': true }
//     });
// }




    const form = document.querySelector('form');
    
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        let { name, lastname, email, password } = form;
        // let user;

        
        app.main.clearErrorMessages('form p')

        if (!app.main.validateEmptyFields([name, lastname, email, password])) return;
        console.log( 'email: ' + email.value + ' password: ' + password.value + ' name: ' + name.value + ' lastname: ' + lastname.value)

        app.signin.createUserAndSetDocument(email.value, password.value, name.value, lastname.value)
        .then((userId) => app.signin.createChat(userId))
        .then(() => {
            window.location.href = '/app.html#admin';
        //     // setTimeout(() => {
        //         // location.reload();
        //     // }, 100);
        })
        .catch((error) => {
            console.log(error);
            if (error.message.includes('invalid-email')){
                app.main.displayErrorMessage('El email ingresado no es válido', email);
            } else if (error.message.includes('email-already-in-use')){
                app.main.displayErrorMessage('Este email ya tiene una cuenta', email);
            } else if (error.message.includes('missing-password')){
                app.main.displayErrorMessage('La contraseña no puede estar vacía', password);
            } else if (error.message.includes('weak-password')){
                app.main.displayErrorMessage('La contraseña debe tener al menos 6 caracteres', password);
            } 
            // ..
        });








        


        // let user;

        // createUserWithEmailAndPassword(auth, email.value, password.value)
        // .then((credentials) => {
        //     // Signed in 
        //     user = credentials.user.uid;
    
        //     console.log(user);
        //     console.log('Se creó el usuario');
        //     return setDoc(doc(db, "roles_by_user", user), {
        //         "nombre": name.value,
        //         "apellido": lastname.value,
        //         "role": 'customer',
        //         createdAt: serverTimestamp(),
        //         updatedAt: serverTimestamp()
        //     });
        // })
        // .then(() => {
        //     // return 
        //     // function createChat(participants) {
        //         console.log('entré a createChat')
        //         const chatRef = ref(db2, 'chats');
        //         const newChatRef = push(chatRef);
        //         return set(newChatRef, {
        //             lastMessage: 'último mensaje',
        //             fecha: Date.now(),
        //             participants: { [user]: true, 'LIsaefMu3BYpF2jINUV9RH78EZs2':true}
        //         })
        //     // };
            
        // })
        // .then(() => {
        //     window.location.href = '/admin.html';
        // })
        // .catch((error) => {
        //     const errorCode = error.code;
        //     const errorMessage = error.message;
        //     console.log("error code: " + errorCode);
        //     console.log("error msg: " + errorMessage);

        //     if (error.message.includes('invalid-email')){
        //         email.parentElement.innerHTML += `<p>El email ingresado no es válido</p>`;
        //     } else if (error.message.includes('missing-password')){
        //         password.parentElement.innerHTML += `<p>La contraseña no puede estar vacía</p>`;
        //     } else if (error.message.includes('weak-password')){
        //         password.parentElement.innerHTML += `<p>La contraseña debe tener al menos 6 caracteres</p>`;
        //     } else if (error.message.includes('email-already-in-use')){
        //         email.parentElement.innerHTML += `<p>Este email ya tiene una cuenta</p>`;
        //     }
        //     // ..
        // });

        

    }) 

</script>
</body>
</html>