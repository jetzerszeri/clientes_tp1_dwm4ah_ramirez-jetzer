<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Añadir servicio</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://kit.fontawesome.com/26eb2bb81f.js" crossorigin="anonymous"></script>
    <!-- <script src="js/main.js" defer></script> -->

    <!-- dropzone -->
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
    <style>
        /* .dz-error-message {
    color: red;
    font-size: 14px;
    margin-top: 10px;
} */

#myForm{
    /* background-color: black; */
    color: black !important;
}
    </style>
</head>
<body>
    <header class="navegacion">
        <nav >
            <div class="navbar">
                <div>
                    <a href="/" class="navbarlogo">GbyG PCS</a>
    
                    <div class="toggle-button">
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </div>
                    
                </div>
    
                <div class="navbar-links">
                    <ul>
                        <li><a href="/">Inicio</a></li>
                        <li><a href="/services.html" >Servicios</a></li>
                        <li><a href="/admin.html" class="active">Dashboard</a></li>
                    </ul>
                    <div>
                        <a href="/login.html" class="btn">Iniciar sesión</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="adminmain">

        <nav class="breadcrumb">
            <ol>
                <li><a href="/">Incio</a></li>
                    <li><a href="/admin.html">Dashboard</a></li>
                    <li><a href="/admin_services.html">Servicios</a></li>
                <li aria-current="page">Agregar</li>
            </ol>
        </nav>
    
        <h1>Panel de administrador</h1>
        <h2>Agregar servicio</h2>
    

        <div class="container ">
            <form action="" >
                <div>
                    <label for="name">Nombre del servicio</label>
                    <input type="text" placeholder="Ingresa el nombre del servicio" name="name">
                </div>
                <div>
                    <label for="category">Categoría</label>
                    <select name="category" id="categorySelect">
                    </select>
                </div>
                <div>
                    <label for="description">Descripción</label>
                    <textarea name="description" cols="30" rows="10"></textarea>
                </div>
                
                <div>
                    <label for="price">Precio por pie cuadrado</label>
                    <input type="number" step="any" placeholder="Ingresa el precio del servicio por pie" name="price">

                </div>
                <div>
                    <label >Imagen</label>
                    <!-- <input type="file" name="img"> -->
                    <div id="myDropzone" class="dropzone"></div>

                </div>


                

            
                <div>
                    <button type="submit" class="btn primary-green">Agregar servicio</button>
                </div>
            </form>
            <!-- <form id="myForm">
                <div id="myDropzone" class="dropzone"></div>
                <button type="submit" id="submit-button">Submit</button>
            </form> -->
        </div>




    </main>

    <footer>
        <div>
            <ul>
                <li><a href="https://www.facebook.com" target="_blank"><i class="fa-brands fa-facebook"></i></a></li>
                <li><a href="https://twitter.com" target="_blank"><i class="fa-brands fa-x-twitter"></i></i></a></li>
                <li><a href="https://www.instagram.com" target="_blank"><i class="fa-brands fa-instagram"></i></a></li>
            </ul>
            <div>
                <p>gbygpcs.com</p>
                <p>© 2023 Copyright</p>
            </div>
        </div>
    </footer>
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>

<script type="module">
    import app from './js/config.js';
    import { success, successMsgAdd } from './js/partials.js';
    import {getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";
    import {getStorage, ref, uploadBytes, getDownloadURL} from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js';

    const storage = getStorage(app)
    const dbfirestore = getFirestore(app);

    const container = document.querySelector('.container');
    const auth = getAuth(app);

    async function addCategoriesList(categoriesSelectInput){
        const querySnapshot = await getDocs(collection(dbfirestore, "categories"));
        querySnapshot.forEach((doc) => {
            let option = document.createElement('option');
            option.value = doc.data().name;
            option.innerHTML = doc.data().name;
            categoriesSelectInput.append(option);
        })

    }

    addCategoriesList(document.querySelector('#categorySelect'));




    const form = document.querySelector('form');
    // let imagen = form.img;

    // imagen.addEventListener('change', function (e) {
    //         e.preventDefault()
    //         console.log('cambio')
    //         let folder = 'avatars/'
    //         let file = e.target.files[0]
    //         let ext = file.type.split('/')[1]
    //         console.log(file)

    // })



    form.addEventListener('submit', (e) => {
        e.preventDefault();

        let { name, category, description, price, img} = form;




        let isValid = true;
        let errorMessages = form.querySelectorAll('p');

        if (errorMessages.length > 0){
            errorMessages.forEach((p) => {
                p.remove();
            })
        }

        if (!name.value.trim()) {
        name.parentElement.innerHTML += `<p>El nombre no puede estar vacío</p>`;
        isValid = false; 
        };

        if (!description.value.trim()) {
            description.parentElement.innerHTML += `<p>La descripción es obligatoria</p>`;
            isValid = false; 
        };
        if (!price.value.trim()) {
            price.parentElement.innerHTML += `<p>El precio no puede estar vacío</p>`;
            isValid = false; 
        };
        // if (img.files.length == 0) {
        //     img.parentElement.innerHTML += `<p>la imagen no puede estar vacío</p>`;
        //     isValid = false; 
        // };

        let dropzoneContainer = document.querySelector('.dropzone').parentElement;
        // console.log(dropzoneContainer);
        
                if (myDropzone.files.length == 0) {
                    console.log(myDropzone.files.length)
                    // Añadir mensaje de error si no hay archivo
                    let errorP = document.createElement('p');
                    errorP.innerText = "La imagen es obligatoria";
                    errorP.classList.add('errorForMmsg');
                    dropzoneContainer.appendChild(errorP);
                    // dropzoneContainer.innerHTML += `<p class="errorForMmsg">La imagen es obligatoria</p>`;
                    // ...
                    return; // No continuar si no hay archivo
                }
                // console.log(myDropzone.files.length)

        if (!isValid) return;
        let file = myDropzone.files[0]; 


        uploadImgToStorageAndAddService('services/', file, name, category, description, price)


        function uploadImgToStorageAndAddService(folderName, dropzoneFile, nameInput, categoryInput, descriptionInput, priceInput){

    //         if (!dropzoneFile || !dropzoneFile.type) {
    //     console.error("Archivo no válido o no definido");
    //     return;
    // }


            let folder = folderName;
            // let file = dropzoneFile;
            let ext = dropzoneFile.type.split('/')[1]
            const storageRef = ref(storage, folder + "test"+ crypto.randomUUID() + '.' + ext);
            console.log(storageRef);


            uploadBytes(storageRef, dropzoneFile).then((snapshot) => {
                console.log(snapshot);
                console.log('Se subió el archivo');

                getDownloadURL(storageRef).then((url) => {
                    console.log(url);

                    addNewServiceToDB(nameInput.value, categoryInput.value, descriptionInput.value, priceInput.value, url);


                }).catch((error) => {
                    console.log(error);
                })
            });


        };




        // let folder = 'services/'
        // let file = img.files[0]
        // let ext = file.type.split('/')[1]
        // const storageRef = ref(storage, folder + "test"+ crypto.randomUUID() + '.' + ext);
        // console.log(storageRef)



        // uploadBytes(storageRef, file).then((snapshot) => {
        //     console.log(snapshot);
        //     console.log('Se subió el archivo');

        //     getDownloadURL(storageRef).then((url) => {
        //         console.log(url);

        //         addNewServiceToDB(name.value, category.value, description.value, price.value, url);


        //     }).catch((error) => {
        //         console.log(error);
        //     })
        // });







        // addNewServiceToDB(name.value, category.value, description.value, price.value);


        // container.innerHTML = successMsgAdd('Servicio agregado exitosamente', '/admin_services.html');
    }) 



    async function addNewServiceToDB(name, category, description, price, imgUrl){
        await addDoc(collection(dbfirestore, "services"), {
            name: name,
            category: category,
            description: description,
            price: price,
            img: imgUrl,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
        });

        console.log('servicio agregado exitosamente');
    }


//     let selectedFiles = [];

//     Dropzone.options.myDropzone = {
//         autoProcessQueue: false,
//         init: function() {
//             var myDropzone = this;

//             this.on("addedfile", function(file) {
//                 selectedFiles.push(file);
//             });

//             // Opcional: Eliminar un archivo del arreglo si el usuario lo remueve de Dropzone
//             this.on("removedfile", function(file) {
//                 selectedFiles = selectedFiles.filter(function(f) { return f !== file; });
//             });
//         }
//     };

//     document.getElementById('myForm').addEventListener('submit', function(event) {
//     event.preventDefault();

//     // Procesar cada archivo seleccionado
//     selectedFiles.forEach(function(file) {
//         // Subir archivo a Firestore
//         // var storageRef = firebase.storage().ref('tus_archivos/' + file.name);
//         // var uploadTask = storageRef.put(file);

//         // uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED,
//         //     function(snapshot) {
//         //         // Opcional: Actualizar el progreso de la carga aquí
//         //     },
//         //     function(error) {
//         //         // Opcional: Manejar errores aquí
//         //     },
//         //     function() {
//         //         // Opcional: Acciones después de que se completa la carga
//         //     }
//         // );

//         console.log(file);
//     });

//     // Limpiar el arreglo y resetear Dropzone si es necesario
//     selectedFiles = [];
//     myDropzone.removeAllFiles();
// });

Dropzone.autoDiscover = false;

let myDropzone = new Dropzone("#myDropzone", { 
    url: "#", // URL ficticia
    autoProcessQueue: false ,
    maxFiles: 1,
    acceptedFiles: 'image/jpeg, image/png, image/jpg, image/webp',
});

// let formPrueba = document.querySelector('#myForm');
// formPrueba.addEventListener('submit', function(e) {
//     e.preventDefault();
//     // myDropzone.processQueue(); // Procesa los archivos en la cola
// });

myDropzone.on("addedfile", function(file) {
    // Ocultar la barra de progreso ya que no se cargará automáticamente
    if (this.files[1]!=null){
        this.removeFile(this.files[0]);
    }
    file.previewElement.querySelector(".dz-progress").style.display = 'none';
    // file.previewElement.querySelector(".dz-error-message").style.display = 'none';

    var removeButton = document.createElement('div');
    removeButton.innerHTML = 'X';
    removeButton.classList.add('dz-remove'); // Puedes añadir clases para estilos

    // Obtener el primer hijo del elemento de vista previa
    var firstChild = file.previewElement.firstChild;

    // Insertar el botón antes del primer hijo del elemento de vista previa
    file.previewElement.insertBefore(removeButton, firstChild);

    // Escuchar el evento de clic en el botón de eliminación
    removeButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // Eliminar el archivo de Dropzone
        myDropzone.removeFile(file);
    });

});

// myDropzone.on("addedfile", function(file) {
//     // Aquí estableces el estado del archivo manualmente
//     // file.status = Dropzone.QUEUED;
//     console.log(file);

//     // Aquí puedes añadir tu lógica personalizada si es necesario
//     // Por ejemplo, almacenar el archivo en un array, como se mencionó antes
// });

// ... resto del código ...

// document.getElementById('submit-button').addEventListener('click', function(e) {
//     e.preventDefault();
//     // myDropzone.processQueue(); // Procesa los archivos en la cola
//     let fileProgressBar = file.previewElement.querySelector(".dz-progress");
//         fileProgressBar.style.display = 'block';
// });


myDropzone.on("error", function(file, response) {
    // `response` es el mensaje de error devuelto por Dropzone
    // Aquí puedes personalizar cómo quieres mostrar el mensaje de error
    // var errorMessage = document.createElement('div');
    // errorMessage.className = 'dz-error-message';
    // errorMessage.textContent = response;
    // console.log(response);
    // file.previewElement.appendChild(errorMessage);


});



</script>


</body>
</html>