<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase 12</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://kit.fontawesome.com/26eb2bb81f.js" crossorigin="anonymous"></script>
    <!-- <script src="js/main.js" defer></script> -->
</head>
<body>
    <style>
        .mainPreviewClase12{
        color: white;
        margin: auto;
        width: 80%;
        }

        form{
            color: black;
        }
    </style>


    <header class="navegacion">
        <nav >
            <div class="navbar">
                <div>
                    <a href="/" class="navbarlogo">GbyG PCS</a>
    
                    <div class="toggle-button">
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </div>
                    
                </div>
    
                <div class="navbar-links">
                    <ul>
                        <li><a href="/">Inicio</a></li>
                        <li><a href="/services.html" >Servicios</a></li>
                        <li><a href="/admin.html">Dashboard</a></li>
                    </ul>
                    <div>
                        <a href="/login.html" class="btn">Iniciar sesión</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="mainPreviewClase12">
    
        <h1>Clase preview</h1>
        

        <img src="https://firebasestorage.googleapis.com/v0/b/tp1-clientes-dwm4ah.appspot.com/o/perro.png?alt=media&token=b9680c71-aa01-46a6-a762-c6d0da01774c&_gl=1*1jqklo9*_ga*NzgzMTY5MTg2LjE2OTIxOTE3NTU.*_ga_CW55HF8NVT*MTY5ODg0MDIzMS4zNi4xLjE2OTg4NDIwMDUuNDUuMC4w" alt="imagen de prueba">

        <div class="loginmain">
            <form action="" enctype="multipart/form-data" id="uploadForm" method="POST">
                
                <div>
                    <label for="">Texto alternativo</label>
                    <input type="text" name="text_alt">
                    <!-- <p>El texto es requerido</p> -->
                </div>
        
                <div>
                    <label for="">Elija un archivo</label>
                    <input type="file" name="avatar">
                </div>
        
                <button class="btn primary-green">Subir</button>
            </form>
        </div>
    
    </main>


<script type="module">
    import app from './js/config.js';
    import {getStorage, ref, uploadBytes, getDownloadURL} from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js';

    //creamos una instancia del storage, conexion con el servicio de storage de firebase
    const storage = getStorage(app);
    
    //ubicamos el formulario por el id y luego accedemos al input del avatar con el name dentro del form
    let uploadForm = document.querySelector('#uploadForm');
    const {avatar, text_alt} = uploadForm;
    // const avatarInput = uploadForm.avatar;
    
    
    avatar.addEventListener('change', function (e){
        e.preventDefault();
        console.log(e.target.files)
        let folder = 'avatars/';
        let file = e.target.files[0];
        let ext = file.type.split('/')[1];
        
        //creamos una referencia al storage
        const storageRef = ref(storage, folder + crypto.randomUUID() + "." + ext); //avatars es la carpeta que tengo. 
        //puedo crear una referencia a una carpeta o a un archivo, solo señala indicando hacia a donde se va a hacer la siguiente operación.
        



        // uploadBytes(storageRef, file).then((snapshot) => {
        //     console.log(snapshot);
        //     console.log('Se subió el archivo');

        








        // });
    }); 

    let textoError = document.createElement('p');
    function agregarTextoError (input, mensajeError){
        textoError.innerHTML = mensajeError;
        if (input.nextSibling) {
            input.nextSibling.remove();
            input.parentNode.insertBefore(textoError, input.nextSibling);
        } else {
            input.parentNode.appendChild(textoError);
        }
    }

    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('submit');
        let textoValido = true;
        let imagenValida = true;
        if(text_alt.value == ""){
            agregarTextoError(text_alt, "El texto alternativo es obligatorio*");
            textoValido = false;
        } else if (text_alt.value.length > 100){
            agregarTextoError(text_alt, "El texto alternativo no debe superar los 100 caracteres*");
            textoValido = false;
        } else if (text_alt.nextSibling) {
            text_alt.nextSibling.remove();
        }


        
        if (avatar.files.length == 0){
            agregarTextoError(avatar, "Debe seleccionar un archivo*");
            imagenValida = false;
        } else if (avatar.files[0].type != "image/png" && avatar.files[0].type != "image/jpg" && avatar.files[0].type != "image/jpeg"){
            agregarTextoError(avatar, "El archivo debe ser una imagen*");
            imagenValida = false;
        } else if (avatar.nextSibling) {
            avatar.nextSibling.remove();
        }




        if (textoValido && imagenValida){
            console.log('texto e imagen validos');
            
            let folder = 'avatars/'
            let file = avatar.files[0]
            let ext = file.type.split('/')[1]
            const storageRef = ref(storage, folder + "test"+ crypto.randomUUID() + '.' + ext);

            uploadBytes(storageRef, file).then((snapshot) => {
                console.log(snapshot);
                console.log('Se subió el archivo');
            });


        } else {
            console.log('texto e imagen invalidos');


        }

        
    })


    // console.log(avatarInput);


</script>
</body>
</html>