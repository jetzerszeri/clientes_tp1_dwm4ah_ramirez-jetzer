<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        form{
            max-width: 400px;
            margin: auto;
        }
        form div {
            margin: 10px 0;
            display: flex;
            flex-direction: column;
        }
        input + p {
            color: red;
            margin: 0 0 10px 0;
            padding: 0;
        }

    </style>
</head>
<body>


    <form 
        method="POST" 
        id="upload" 
        action="preview.html" 
        enctype="multipart/form-data"
    >
        <div>
            <label for="">Texto alternativo</label>
            <input type="text" name="text_alt">
        </div>

        <div>
            <label for="">Elija un archivo</label>
            <input type="file" name="avatar">
        </div>

        <button>Subir</button>
    </form>

    <div class="container">
        <!-- <img src="" alt="">
        <p>Imagen agregada exitosamente a la base de datos</p> -->
    </div>

    <script type="module">
        import app from './js/config.js';
        import {getStorage, ref, uploadBytes, getDownloadURL} from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js';
        import {getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js';

        // conexion con el servicio firebase storage
        const storage = getStorage(app)
        const db = getFirestore(app);

        // ubicamos el formulario por el id
        const uploadForm = document.getElementById('upload');
        const {avatar, text_alt} = uploadForm;

        // accedemos al input del avatar por el nombre dentro del formulario
        // const avatarInput = uploadForm.avatar

        avatar.addEventListener('change', function (e) {
            e.preventDefault()
            console.log('cambio')
            let folder = 'avatars/'
            let file = e.target.files[0]
            let ext = file.type.split('/')[1]
            
            // creamos una referencia al storage
            const storageRef = ref(storage, folder + crypto.randomUUID() + '.' + ext);

            // uploadBytes(storageRef, file).then((snapshot) => {
            //     console.log(snapshot);
            //     console.log('Uploaded a blob or file!');

            //     // continuar aca...

            // });


        })


        let textoError = document.createElement('p');
    function agregarTextoError (input, mensajeError){
        textoError.innerHTML = mensajeError;
        if (input.nextSibling) {
            input.nextSibling.remove();
            input.parentNode.insertBefore(textoError, input.nextSibling);
        } else {
            input.parentNode.appendChild(textoError);
        }
    }

    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('submit');
        let textoValido = true;
        let imagenValida = true;
        if(text_alt.value == ""){
            agregarTextoError(text_alt, "El texto alternativo es obligatorio*");
            textoValido = false;
        } else if (text_alt.value.length > 100){
            agregarTextoError(text_alt, "El texto alternativo no debe superar los 100 caracteres*");
            textoValido = false;
        } else if (text_alt.nextSibling) {
            text_alt.nextSibling.remove();
        }


        
        if (avatar.files.length == 0){
            agregarTextoError(avatar, "Debe seleccionar un archivo*");
            imagenValida = false;
        } else if (avatar.files[0].type != "image/png" && avatar.files[0].type != "image/jpg" && avatar.files[0].type != "image/jpeg"){
            agregarTextoError(avatar, "El archivo debe ser una imagen*");
            imagenValida = false;
        } else if (avatar.nextSibling) {
            avatar.nextSibling.remove();
        }




        if (textoValido && imagenValida){
            console.log('texto e imagen validos');

            let folder = 'avatars/'
            let file = avatar.files[0]
            let ext = file.type.split('/')[1]
            const storageRef = ref(storage, folder + "test"+ crypto.randomUUID() + '.' + ext);

            uploadBytes(storageRef, file).then((snapshot) => {
                console.log(snapshot);
                console.log('Se subiÃ³ el archivo');

                // continuar aca...
                getDownloadURL(storageRef).then((url) => {
                    console.log(url);


                    addDoc(collection(db, "photos"), {
                        url: url,
                        text_alt: text_alt.value,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    }).then((docRef) => {
                        let alt = text_alt;
                        // console.log("Document written with ID: ", docRef.id);
                        console.log(text_alt)
                        let container = document.querySelector('.container');
                        container.innerHTML = `
                            <img src="${url}" alt="${text_alt.value}">
                            <p>Imagen agregada exitosamente a la base de datos</p>
                        `;

                    


                        // window.location.href = '/admin_avatars.html';
                        uploadForm.reset();
                    }).catch((error) => {
                        console.error("Error adding document: ", error);
                    });
                   


                })
            });

            


            
        } else {
            console.log('texto e imagen invalidos');
        }

        
    })



        console.log(avatar)
    </script>
    
    <!--
    <img src="https://firebasestorage.googleapis.com/v0/b/da-vinci-cliente-web-mobile.appspot.com/o/descarga.png?alt=media&token=bce016f7-77b7-47e7-adf3-ea9c60a95f74_gl=1*1i0vj3q*_ga*MTIxMzc5NjEyNi4xNjk4ODQwMzYw*_ga_CW55HF8NVT*MTY5ODg0MDM2MC4xLjEuMTY5ODg0MjA0MS4yMi4wLjA." alt="">
-->

</body>
</html>